<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ICA ERP - Modern Theme</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- THEME SETTINGS --- */
        :root { 
            --brand: #1c9c6a; 
            --brand-dark: #147b55; 
            --accent: #2bbf84; 
            --text-main: #0f172a;
            --text-light: #64748b;
            --bg: #eef2f7;
            --surface: #ffffff;
            --surface-2: #f8fafc;
            --sidebar-w: 260px;
            --success: #16a34a; 
            --danger: #ef4444; 
            --gold: #b7791f; 
            --purple: #7c3aed; 
            --shadow-sm: 0 6px 16px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 12px 30px rgba(15, 23, 42, 0.10);
        }

        body { 
            font-family: 'Manrope', sans-serif; 
            background: radial-gradient(1200px 600px at 10% -20%, #e7f7f0 0%, transparent 60%),
                        radial-gradient(900px 400px at 100% 0%, #edf1ff 0%, transparent 55%),
                        var(--bg); 
            margin: 0; 
            color: var(--text-main); 
            overflow-x: hidden; 
            min-height: 100vh;
        }
        
        /* LOGIN OVERLAY */
        #loginOverlay { position: fixed; inset: 0; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 42px; border-radius: 16px; width: 340px; text-align: center; box-shadow: var(--shadow-md); border: 1px solid #e2e8f0; }
        
        #mainApp { display: none; }
        
        /* LAYOUT */
        .nav-bar { 
            position: fixed; top: 0; left: 0; width: var(--sidebar-w); height: 100vh; background: var(--surface); border-right: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; padding: 90px 18px 22px 18px; gap: 6px; z-index: 900; box-sizing: border-box;
            box-shadow: 12px 0 30px rgba(15, 23, 42, 0.04);
        }
        .top-bar { 
            background: rgba(255, 255, 255, 0.95); color: var(--text-main); padding: 18px 36px; display: flex; justify-content: space-between; align-items: center; 
            margin-left: var(--sidebar-w); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 800;
            backdrop-filter: blur(10px);
        }
        .nav-bar::before { content: "Computer Academy"; position: absolute; top: 26px; left: 26px; font-size: 18px; font-weight: 800; color: var(--text-main); letter-spacing: 0.3px; }
        .nav-bar::after { content: ""; position: absolute; top: 33px; left: 200px; width: 10px; height: 10px; background: var(--brand); border-radius: 50%; box-shadow: 0 0 0 6px rgba(43, 191, 132, 0.15); }
        
        .nav-btn { 
            padding: 12px 16px; border: none; background: transparent; border-radius: 10px; cursor: pointer; font-weight: 600; color: var(--text-light); 
            text-align: left; width: 100%; transition: 0.2s; display: flex; align-items: center; gap: 12px;
        }
        .nav-btn:hover { background: #f1f5f9; color: var(--text-main); transform: translateX(2px); }
        .nav-btn.active { background: rgba(28, 156, 106, 0.12); color: var(--brand); font-weight: 700; box-shadow: inset 3px 0 0 var(--brand); }
        
        .container { max-width: 100%; margin-left: var(--sidebar-w); padding: 32px 36px 50px; }
        
        .section { display: none; animation: fadeIn 0.3s ease; } 
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--surface); padding: 26px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm); }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
        .kpi-card { display: flex; align-items: center; justify-content: space-between; gap: 14px; padding: 18px 20px; }
        .kpi-meta { display: flex; flex-direction: column; gap: 6px; }
        .kpi-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 700; }
        .kpi-value { font-size: 26px; font-weight: 800; color: #0f172a; }
        .kpi-pill { font-size: 12px; font-weight: 700; padding: 6px 10px; border-radius: 999px; background: rgba(28, 156, 106, 0.12); color: var(--brand); }
        .kpi-danger { background: rgba(239, 68, 68, 0.12); color: var(--danger); }
        .kpi-gold { background: rgba(183, 121, 31, 0.15); color: var(--gold); }
        
        h2, h3 { font-weight: 800; color: #0f172a; margin-top: 0; letter-spacing: -0.2px; }
        
        .grid-5 { display:grid; grid-template-columns: repeat(5, 1fr); gap:15px; }
        .grid-6 { display:grid; grid-template-columns: repeat(6, 1fr); gap:15px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
        th { background: var(--surface-2); color: #475569; font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.6px; border-top: 1px solid #e2e8f0; }
        tbody tr:hover { background: #f8fafc; }
        table thead tr th:first-child { border-top-left-radius: 10px; }
        table thead tr th:last-child { border-top-right-radius: 10px; }
        
        input, select { 
            padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; width: 100%; margin-top: 5px; box-sizing: border-box; 
            background: #fff; color: #1f2937; outline: none; font-weight: 500;
        }
        input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(28, 156, 106, 0.15); }
        small { font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.4px; }
        .form-row { display: grid; gap: 16px; }
        .form-row.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .form-row.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .form-row.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .form-row.cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .form-row.cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        .panel { background: var(--surface-2); border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; }
        
        button { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 12px; text-transform: uppercase; letter-spacing: 0.4px; }
        .btn-blue { background: var(--brand); color: white; box-shadow: 0 10px 18px rgba(28, 156, 106, 0.2); }
        .btn-blue:hover { background: var(--brand-dark); transform: translateY(-1px); }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        
        /* Attendance Toggle */
        .att-btn { padding: 5px 10px; cursor: pointer; border: 1px solid #e2e8f0; background: #fff; margin-right: 2px; border-radius: 4px; }
        .att-btn.sel-p { background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981; }
        .att-btn.sel-a { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: #ef4444; }

        #printArea { display: none; }
        
        /* PRINT SETTINGS (FIXED: Auto Orientation) */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            @page { size: auto; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            table { width: 100% !important; font-size: 10px !important; border-collapse: collapse; }
            th, td { padding: 2px !important; border: 1px solid #000 !important; }
            .adm-form-box { width: 100% !important; border: 2px solid #000 !important; }
        }

        /* Certificate Styles */
        .cert-box { width: 900px; height: 650px; border: 20px solid #1e293b; padding: 5px; background: #fff; margin: auto; position: relative; box-sizing: border-box;}
        .cert-inner { border: 5px double var(--gold); height: 100%; padding: 40px; text-align: center; box-sizing: border-box; position: relative; z-index: 1;}
        .cert-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; opacity: 0.1; z-index: -1; }
        .cert-header { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 20px; text-align: left;}
        .cert-logo { width: 100px; height: 100px; object-fit: contain; margin-right: 20px;}
        .cert-title { font-size: 45px; font-family: 'Times New Roman', serif; color: #1e293b; margin: 0; flex: 1; }
        .cert-student-name { font-family: 'Arial', sans-serif; font-size: 42px; color: #1e40af; font-weight: bold; margin: 15px 0; text-transform: uppercase; }
        
        .id-card-box { width: 340px; height: 215px; border: 1px solid #000; border-radius: 8px; overflow: hidden; position: relative; background: #fff; font-family: sans-serif; }
        .id-header { background: #1e293b; color: white; padding: 10px; display: flex; align-items: center; gap: 10px; height: 50px; }
        .id-body { display: flex; padding: 10px; gap: 10px; align-items: center; height: 110px; }
        .id-footer { background: var(--brand); height: 25px; position: absolute; bottom: 0; width: 100%; text-align: center; color: white; font-size: 10px; line-height: 25px; }
        
        .adm-form-box { width: 100%; max-width: 700px; margin: auto; border: 2px solid #000; padding: 20px; font-family: 'Times New Roman', serif; box-sizing: border-box; }
        
        .report-header { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
        .report-header p { margin: 0; color: var(--text-light); font-size: 13px; }
        .report-toolbar { background: var(--surface-2); border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; display: grid; gap: 16px; }
        .report-preview { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 22px; box-shadow: var(--shadow-sm); }
        .report-preview table { margin-top: 12px; border-collapse: separate; border-spacing: 0; }
        .report-preview table th { background: #eef2f7; }
        .report-preview hr { border: none; border-top: 1px solid #e2e8f0; margin: 16px 0; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:var(--brand); margin-bottom: 5px;">Welcome Back</h2>
        <p style="color:#64748b; margin-top:0; margin-bottom:20px;">Enter credentials to access dashboard</p>
        <input type="text" id="uID" placeholder="Username">
        <input type="password" id="uPass" placeholder="Password">
        <button class="btn-blue" style="width:100%; margin-top:15px;" onclick="checkLogin()">LOGIN</button>
    </div>
</div>

<div id="mainApp">
    
    <div class="nav-bar">
        <button class="nav-btn active" onclick="tab('dash', this)"><span>üìä</span> Dashboard</button>
        <button class="nav-btn" onclick="tab('adm', this)"><span>üë§</span> Students</button>
        <button class="nav-btn" onclick="tab('fee', this)"><span>üí∞</span> Fees & Pay</button>
        <button class="nav-btn" onclick="tab('expTab', this)"><span>üí∏</span> Expenses</button>
        <button class="nav-btn" onclick="tab('attTab', this)"><span>üìã</span> Attendance</button>
        <button class="nav-btn" onclick="tab('reportTab', this)"><span>üìÑ</span> Reports</button>
        <button class="nav-btn" onclick="tab('gr_list', this)"><span>üóÇ</span> Database</button>
        <button class="nav-btn" onclick="tab('certTab', this)"><span>üìÇ</span> Documents</button>
    </div>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:12px;">
            <img id="navLogo" src="" style="width:40px; height:40px; background:white; border-radius:5px; object-fit:contain; border:1px solid #eee;">
            <h3 style="margin:0; font-weight:700;">IKHAR COMPUTER ACADEMY</h3>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-blue" style="background:white; color:var(--text-main); border:1px solid #e2e8f0;" onclick="document.getElementById('logoInp').click()">Upload Logo</button>
            <input type="file" id="logoInp" style="display:none" onchange="saveLogo(this)">
            <button class="btn-red" onclick="masterReset()">Reset App</button>
        </div>
    </div>

    <div class="container">
        <div id="dash" class="section active">
            <h2 style="margin-bottom:20px;">Overview</h2>
            <div class="kpi-grid">
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Collection</span>
                        <span id="dColl" class="kpi-value" style="color:var(--success)">‚Çπ0</span>
                    </div>
                    <span class="kpi-pill">+ Revenue</span>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Expenses</span>
                        <span id="dExp" class="kpi-value" style="color:var(--danger)">‚Çπ0</span>
                    </div>
                    <span class="kpi-pill kpi-danger">Outflow</span>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Net Profit</span>
                        <span id="dNet" class="kpi-value" style="color:var(--brand)">‚Çπ0</span>
                    </div>
                    <span class="kpi-pill">Summary</span>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Students</span>
                        <span id="d1" class="kpi-value">0</span>
                    </div>
                    <span class="kpi-pill">Active</span>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Dues</span>
                        <span id="dDue" class="kpi-value" style="color:var(--danger)">‚Çπ0</span>
                    </div>
                    <span class="kpi-pill kpi-danger">Pending</span>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-meta">
                        <span class="kpi-label">Zakat Fund</span>
                        <span id="dZakat" class="kpi-value" style="color:var(--gold)">‚Çπ0</span>
                    </div>
                    <span class="kpi-pill kpi-gold">Reserved</span>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:25px;">
                <div class="card"><h3 style="margin-bottom:15px;">Revenue Trend</h3><canvas id="revChart" height="120"></canvas></div>
                <div class="card"><h3 style="margin-bottom:15px;">Profit Distribution</h3><canvas id="dueChart" height="120"></canvas></div>
            </div>
        </div>

        <div id="adm" class="section">
            <div class="card">
                <h3>Student Admission</h3>
                <div class="form-row cols-5">
                    <input type="hidden" id="editIdx" value="-1">
                    <div><small>Roll No</small><input type="text" id="sGr" placeholder="Roll"></div>
                    <div><small>Full Name</small><input type="text" id="sName" placeholder="Full Name"></div>
                    <div><small>Course</small><input type="text" id="sCourse" placeholder="Course"></div>
                    <div><small>Duration</small><input type="text" id="sDur" placeholder="Duration"></div>
                    <div><small>Total Fees</small><input type="number" id="sTotal" placeholder="Total Fees"></div>
                </div>
                <div class="form-row cols-4" style="margin-top:15px;">
                    <div><small>Mobile No</small><input type="text" id="sMob" placeholder="Mobile"></div>
                    <div><small>From Date</small><input type="date" id="sDate"></div>
                    <div><small>To Date</small><input type="date" id="sToDate"></div>
                    <div><small>Photo</small><input type="file" id="photoInp" onchange="readImg(this)"></div>
                </div>
                <button class="btn-blue" style="width:100%; margin-top:20px;" onclick="addStudent()">+ Add Student</button>
            </div>
        </div>

        <div id="fee" class="section">
            <div class="card panel">
                <h3 style="margin:0 0 10px 0;">Manage Receipt</h3>
                <div class="form-row cols-4" style="align-items:end;">
                    <div><small>Enter Receipt No (REC-173...)</small><input type="text" id="editRNo" placeholder="Enter Receipt No (REC-173...)"></div>
                    <button class="btn-blue" onclick="loadReceiptForEdit()">Edit</button>
                    <button class="btn-green" onclick="reprintReceipt()">Print</button>
                    <button class="btn-red" onclick="deleteReceipt()">Delete</button>
                </div>
            </div>
            <div class="card">
                <h3 style="color:var(--brand)">Desk 1: Course + Zakat</h3>
                <div class="form-row cols-6" style="align-items:end;">
                    <input type="hidden" id="editFeeIdx" value="-1">
                    <div><small>Roll No</small><input type="text" id="rollInp1" placeholder="Roll" onkeyup="findStudentByRoll(this.value, 'feeDrop1')"></div>
                    <div><small>Select Student</small><select id="feeDrop1" onchange="updateDueLabel()"></select></div>
                    <div><small>Month/Year</small><input type="month" id="payPeriod"></div>
                    <div><small>Course Amt</small><input type="number" id="payCourse" placeholder="Amt"></div>
                    <div><small>Zakat Amt</small><input type="number" id="payZakat" placeholder="Amt"></div>
                    <button class="btn-blue" onclick="collectFee('COURSE')">Record Payment</button>
                </div>
                <p style="margin-top:10px; font-weight:600;">Pending Due: <b id="dueLabel" style="color:var(--danger)">‚Çπ0</b></p>
            </div>
            <div class="card">
                <h3 style="color:var(--gold)">Desk 2: Exam + Certificate</h3>
                <div class="form-row cols-6" style="align-items:end;">
                    <div><small>Roll No</small><input type="text" id="rollInp2" placeholder="Roll" onkeyup="findStudentByRoll(this.value, 'feeDrop2')"></div>
                    <div><small>Select Student</small><select id="feeDrop2"></select></div>
                    <div><small>Month/Year</small><input type="month" id="payPeriod2"></div>
                    <div><small>Exam Fee</small><input type="number" id="payExam" placeholder="Amt"></div>
                    <div><small>Cert Fee</small><input type="number" id="payCert" placeholder="Amt"></div>
                    <button class="btn-blue" style="background:var(--gold)" onclick="collectFee('EXAM')">Record Payment</button>
                </div>
            </div>
        </div>

        <div id="expTab" class="section">
            <div class="card">
                <h3 style="color:var(--danger)">Record Manual Expense</h3>
                <div class="form-row cols-4" style="align-items:end; grid-template-columns: 2fr 1fr 1fr auto;">
                    <div><small>Expense Name/Detail</small><input type="text" id="expName" placeholder="e.g. Electricity Bill, Rent, Maintenance"></div>
                    <div><small>Amount (‚Çπ)</small><input type="number" id="expAmt" placeholder="0"></div>
                    <div><small>Date</small><input type="date" id="expDate"></div>
                    <button class="btn-red" onclick="addExpense()">Add Expense</button>
                </div>
            </div>
            <div class="card">
                <h3>Expense Log</h3>
                <div style="overflow-x:auto"><table id="expTable"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Action</th></tr></thead><tbody id="expBody"></tbody></table></div>
            </div>
        </div>

        <div id="attTab" class="section">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                <div class="card">
                    <h3 style="color:var(--brand)">üë®‚Äçüéì Student Attendance</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                        <input type="date" id="attDateS" onchange="renderAtt('S')">
                        <button class="btn-blue" onclick="saveAtt('S')">Save Changes</button>
                    </div>
                    <div style="height:400px; overflow-y:auto; border:1px solid #e2e8f0; padding:10px; border-radius:6px;">
                        <table id="attTableS"></table>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="color:var(--purple)">üë®‚Äçüè´ Teacher Management</h3>
                    <div class="panel" style="margin-bottom:15px;">
                        <h4 style="margin:0 0 10px 0">Add New Teacher</h4>
                        <div class="form-row cols-3" style="grid-template-columns: 1.4fr 1.4fr auto; align-items:end;">
                            <input type="text" id="tName" placeholder="Teacher Name">
                            <input type="text" id="tSub" placeholder="Subject">
                            <button class="btn-purple" style="background:var(--purple); color:white;" onclick="addTeacher()">Add</button>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom:10px">Teacher Attendance</h4>
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                        <input type="date" id="attDateT" onchange="renderAtt('T')">
                        <button class="btn-purple" style="background:var(--purple); color:white;" onclick="saveAtt('T')">Save Changes</button>
                    </div>
                    <div style="height:250px; overflow-y:auto; border:1px solid #e2e8f0; padding:10px; border-radius:6px;">
                        <table id="attTableT"></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="reportTab" class="section">
            <div class="card">
                <div class="report-header">
                    <h3 style="margin:0">Report Center</h3>
                    <p>Generate clean, printable reports with filters and quick actions.</p>
                </div>
                <div class="report-toolbar">
                    <div class="form-row cols-4" style="grid-template-columns: repeat(3, minmax(0, 1fr)) auto; align-items:end;">
                        <div><small>From Date</small><input type="date" id="repFrom"></div>
                        <div><small>To Date</small><input type="date" id="repTo"></div>
                        <div><small>OR Filter by Month</small><input type="month" id="repMonthFilter"></div>
                        <button class="btn-red" style="padding: 10px 15px;" onclick="resetFilters()">Reset Filters</button>
                    </div>
                    <div class="form-row cols-6">
                        <button class="btn-green" onclick="genReport('COURSE')">Collection Rep</button>
                        <button class="btn-red" onclick="genReport('EXPENSE')">Expense Rep</button>
                        <button class="btn-gold" style="background:#334155; color:white;" onclick="genReport('BALANCE')">Balance Sheet</button>
                        <button class="btn-blue" onclick="genReport('ZAKAT')">Zakat Rep</button>
                        <button class="btn-blue" style="background:#8b5cf6" onclick="genReport('EXAM')">Exam Report</button>
                        <button class="btn-red" style="background:#475569" onclick="genReport('DUE')">Due Rep</button>
                        <button class="btn-purple" style="background:var(--accent); color:white;" onclick="genReport('ATT_S_REP')">Student Att. Report</button>
                        <button class="btn-purple" style="background:var(--purple); color:white;" onclick="genReport('ATT_T_REP')">Teacher Att. Report</button>
                    </div>
                    <div class="form-row cols-2" style="align-items:end;">
                        <div><small>Student Ledger</small><input type="text" id="searchRoll" placeholder="Search Roll No for Ledger"></div>
                        <button class="btn-blue" onclick="genStudentRecord()">Student Ledger</button>
                    </div>
                </div>
                <div id="reportPreview" class="report-preview" style="margin-top:25px; overflow-x: auto;"></div>
                <button class="btn-blue" style="width:100%; margin-top:15px;" onclick="printThisReport()">Print Now</button>
            </div>
        </div>

        <div id="gr_list" class="section">
            <div class="card">
                <h3>Student Database</h3>
                <input type="text" id="dbSearch" placeholder="Search Database..." onkeyup="renderDatabase()" style="margin-bottom:15px;">
                <div style="overflow-x:auto"><table id="grBody"></table></div>
            </div>
        </div>

        <div id="certTab" class="section">
            <div class="card">
                <h3>Documents & Certificates</h3>
                <div class="form-row cols-2" style="grid-template-columns: 2fr 1fr; align-items:center;">
                    <select id="certDrop" style="flex:2"></select>
                </div>
                <div class="form-row cols-3" style="margin-top:20px;">
                    <div class="panel" style="flex:1;">
                        <h4>1. Certificate</h4>
                        <select id="certGrade" style="width:100%; margin-bottom:10px;"><option value="A+">Grade: A+</option><option value="A">Grade: A</option><option value="B">Grade: B</option></select>
                        <button class="btn-gold" style="width:100%" onclick="printCert()">Generate Certificate</button>
                    </div>
                    <div class="panel" style="flex:1;">
                        <h4>2. ID Card</h4>
                        <button class="btn-blue" style="width:100%" onclick="printIdCard()">Print Landscape ID</button>
                    </div>
                    <div class="panel" style="flex:1;">
                        <h4>3. Admission Form</h4>
                        <button class="btn-red" style="width:100%" onclick="printAdmForm()">Print Adm Form</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="printArea"></div>

<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDN-8WHQskvFDPPRAjTqXkEQqRBtCFglZM", authDomain: "mm-high--school.firebaseapp.com", projectId: "mm-high--school", databaseURL: "https://mm-high--school-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = [], fees = [], expenses = [], academyLogo = "", tempImg = "", revChart = null, dueChart = null;
    let teachers = [], attDataS = [], attDataT = []; 

    function checkLogin() {
        if(document.getElementById('uID').value === "ica" && document.getElementById('uPass').value === "ica007") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        } else alert("Invalid Credentials");
    }

    function loadData() {
        db.ref('ica_final_v3').on('value', snap => {
            const data = snap.val();
            if(data) { 
                students = data.students || []; 
                fees = data.fees || []; 
                expenses = data.expenses || [];
                teachers = data.teachers || [];
                attDataS = data.attDataS || [];
                attDataT = data.attDataT || [];
                academyLogo = data.logo || "";
                if(academyLogo) document.getElementById('navLogo').src = academyLogo;
            }
            render(); updateCharts(); renderExpTable();
        });
    }

    function sync() { 
        db.ref('ica_final_v3').set({students, fees, expenses, logo: academyLogo, teachers, attDataS, attDataT}); 
    }

    function addStudent() {
        let idx = parseInt(document.getElementById('editIdx').value);
        let s = {
            id: document.getElementById('sGr').value,
            name: document.getElementById('sName').value,
            course: document.getElementById('sCourse').value,
            dur: document.getElementById('sDur').value,
            total: parseFloat(document.getElementById('sTotal').value || 0),
            mob: document.getElementById('sMob').value,
            date: document.getElementById('sDate').value,
            toDate: document.getElementById('sToDate').value,
            photo: tempImg || (idx > -1 ? students[idx].photo : ""),
            paid: idx > -1 ? students[idx].paid : 0,
            status: idx > -1 ? students[idx].status : "Active"
        };
        if(idx > -1) students[idx] = s; else students.push(s);
        sync(); resetForm(); alert("Saved!");
    }

    function findStudentByRoll(roll, dropId) {
        if(!roll) return;
        let idx = students.findIndex(s => s.id === roll && s.status === 'Active');
        if(idx !== -1) {
            document.getElementById(dropId).value = idx;
            if(dropId === 'feeDrop1') updateDueLabel();
        }
    }

    function addExpense() {
        let name = document.getElementById('expName').value;
        let amt = parseFloat(document.getElementById('expAmt').value || 0);
        let date = document.getElementById('expDate').value;
        if(!name || amt <= 0 || !date) return alert("Please fill details correctly");
        expenses.unshift({id: Date.now(), name, amt, date});
        sync(); document.getElementById('expName').value = ""; document.getElementById('expAmt').value = ""; alert("Expense Added");
    }
    
    function deleteExp(id) { if(confirm("Delete this expense entry?")) { expenses = expenses.filter(x => x.id !== id); sync(); } }
    function renderExpTable() { document.getElementById('expBody').innerHTML = expenses.map(x => `<tr><td>${x.date}</td><td>${x.name}</td><td>‚Çπ${x.amt}</td><td><button class="btn-red" onclick="deleteExp(${x.id})">X</button></td></tr>`).join(''); }

    function reprintReceipt() { let rno = document.getElementById('editRNo').value; let f = fees.find(f => f.rNo === rno); if(!f) return alert("Receipt Not Found"); printReceipt(f); }

    function deleteReceipt() {
        let rno = document.getElementById('editRNo').value;
        let idx = fees.findIndex(f => f.rNo === rno);
        if(idx === -1) return alert("Receipt Not Found");
        if(confirm("Permanently Delete? Student balance will be updated.")) {
            let f = fees[idx];
            if(f.type === 'COURSE') { let s = students.find(st => st.id === f.sid); if(s) s.paid -= f.total; }
            fees.splice(idx, 1); sync(); alert("Deleted"); document.getElementById('editRNo').value = "";
        }
    }

    function loadReceiptForEdit() {
        let rno = document.getElementById('editRNo').value;
        let idx = fees.findIndex(f => f.rNo === rno);
        if(idx === -1) return alert("Receipt Not Found");
        let f = fees[idx]; document.getElementById('editFeeIdx').value = idx;
        if(f.type === 'COURSE') {
            let sIdx = students.findIndex(s => s.id === f.sid); document.getElementById('feeDrop1').value = sIdx; document.getElementById('payPeriod').value = f.period; document.getElementById('payCourse').value = f.v1; document.getElementById('payZakat').value = f.v2; alert("Loaded in Desk 1");
        } else {
            let sIdx = students.findIndex(s => s.id === f.sid); document.getElementById('feeDrop2').value = sIdx; document.getElementById('payPeriod2').value = f.period; document.getElementById('payExam').value = f.v1; document.getElementById('payCert').value = f.v2; alert("Loaded in Desk 2");
        }
    }

    function collectFee(type) {
        let i = document.getElementById(type === 'COURSE' ? 'feeDrop1' : 'feeDrop2').value;
        if(i === "") return;
        let s = students[i];
        let editIdx = parseInt(document.getElementById('editFeeIdx').value);
        if(editIdx > -1) { let oldF = fees[editIdx]; let oldS = students.find(st => st.id === oldF.sid); if(oldS && oldF.type === 'COURSE') oldS.paid -= oldF.total; }
        let date = new Date().toISOString().split('T')[0];
        let rNo = editIdx > -1 ? fees[editIdx].rNo : "REC-" + Date.now();
        let f = { sid: s.id, name: s.name, course: s.course, date, rNo, type };
        if(type === 'COURSE') {
            let p = parseFloat(document.getElementById('payCourse').value || 0); let z = parseFloat(document.getElementById('payZakat').value || 0); let mon = document.getElementById('payPeriod').value; if(!mon) return alert("Select Month");
            s.paid += (p + z); f.v1 = p; f.v2 = z; f.total = p+z; f.period = mon;
        } else {
            let e = parseFloat(document.getElementById('payExam').value || 0); let c = parseFloat(document.getElementById('payCert').value || 0); let mon2 = document.getElementById('payPeriod2').value; if(!mon2) return alert("Select Month");
            f.v1 = e; f.v2 = c; f.total = e+c; f.period = mon2; f.dur = s.dur; f.admDate = s.date; f.toDate = s.toDate;
        }
        if(editIdx > -1) { fees[editIdx] = f; document.getElementById('editFeeIdx').value = "-1"; document.getElementById('editRNo').value = ""; } else { fees.unshift(f); }
        sync(); printReceipt(f); document.getElementById('rollInp1').value = ""; document.getElementById('rollInp2').value = "";
    }

    function printReceipt(d) {
        let periodLine = d.period ? `<p style="font-size:16px;"><b>For Month:</b> ${d.period}</p>` : "";
        let h = `<div style="padding:40px; border:2px solid #000; width:500px; margin:auto; font-family:sans-serif; background:#fff;"><div style="display:flex; align-items:center; gap:15px;"><img src="${academyLogo}" style="width:70px;"><h2 style="margin:0; font-size:22px;">IKHAR COMPUTER ACADEMY</h2></div><hr style="border:1px solid #000"><p style="font-size:16px;"><b>Date:</b> ${d.date} <span style="float:right"><b>No:</b> ${d.rNo}</span></p><p style="font-size:16px;"><b>Student:</b> ${d.name} (${d.sid})</p>${periodLine}<table border="1" style="width:100%; border-collapse:collapse; font-size:16px; margin-top:15px;"><tr><td style="padding:10px">${d.type==='COURSE'?'Course Fee':'Exam Fee'}</td><td style="padding:10px">‚Çπ${d.v1}</td></tr><tr><td style="padding:10px">${d.type==='COURSE'?'Zakat Fund':'Cert Fee'}</td><td style="padding:10px">‚Çπ${d.v2}</td></tr><tr style="font-weight:bold; background:#eee;"><td style="padding:10px">TOTAL</td><td style="padding:10px">‚Çπ${d.total}</td></tr></table><div style="margin-top:40px; display:flex; justify-content:space-between; align-items:flex-end;"><p style="font-size:12px;">Computer Generated Receipt</p><div style="text-align:center;"><p style="margin:0; font-size:16px;"><b>Authorized Signature</b></p></div></div></div>`;
        document.getElementById('printArea').innerHTML = h; window.print();
    }

    function addTeacher() {
        let n = document.getElementById('tName').value;
        let sub = document.getElementById('tSub').value;
        if(!n) return alert("Name required");
        teachers.push({id: Date.now(), name: n, sub: sub});
        sync(); document.getElementById('tName').value = ""; document.getElementById('tSub').value = "";
        renderAtt('T');
    }

    function renderAtt(type) {
        let date = document.getElementById(type === 'S' ? 'attDateS' : 'attDateT').value;
        if(!date) return;
        
        let list = (type === 'S') ? students.filter(s=>s.status==='Active') : teachers;
        let log = (type === 'S') ? attDataS : attDataT;
        let todayLog = log.find(x => x.date === date);
        let records = todayLog ? todayLog.data : {};

        let h = `<tr style="background:#f1f5f9;"><th>Name</th><th>Status (P/A)</th></tr>`;
        
        list.forEach(item => {
            let id = (type === 'S') ? item.id : item.id;
            let status = records[id] || 'P';
            let pClass = status === 'P' ? 'sel-p' : '';
            let aClass = status === 'A' ? 'sel-a' : '';
            
            h += `<tr>
                <td>${item.name} <small>${type==='T' ? '('+item.sub+')' : ''}</small></td>
                <td>
                    <button class="att-btn ${pClass}" onclick="toggleAtt(this, 'P')">P</button>
                    <button class="att-btn ${aClass}" onclick="toggleAtt(this, 'A')">A</button>
                    <input type="hidden" class="att-val" data-id="${id}" value="${status}">
                    ${type==='T' ? `<button style="margin-left:5px; color:red; font-size:10px;" onclick="delTeacher(${item.id})">X</button>` : ''}
                </td>
            </tr>`;
        });
        document.getElementById(type === 'S' ? 'attTableS' : 'attTableT').innerHTML = h;
    }

    function toggleAtt(btn, state) {
        let parent = btn.parentElement;
        parent.querySelectorAll('.att-btn').forEach(b => b.className = 'att-btn');
        btn.classList.add(state === 'P' ? 'sel-p' : 'sel-a');
        parent.querySelector('.att-val').value = state;
    }

    function saveAtt(type) {
        let date = document.getElementById(type === 'S' ? 'attDateS' : 'attDateT').value;
        if(!date) return alert("Select Date");
        let rows = document.getElementById(type === 'S' ? 'attTableS' : 'attTableT').querySelectorAll('.att-val');
        let data = {};
        rows.forEach(r => data[r.getAttribute('data-id')] = r.value);
        
        let logArr = (type === 'S') ? attDataS : attDataT;
        let idx = logArr.findIndex(x => x.date === date);
        
        if(idx > -1) logArr[idx].data = data;
        else logArr.push({date: date, data: data});
        
        sync(); alert("Attendance Saved!");
    }

    function delTeacher(id) {
        if(confirm("Delete Teacher?")) {
            teachers = teachers.filter(t => t.id !== id);
            sync(); renderAtt('T');
        }
    }

    // --- NEW: Reset Filter Button Function ---
    function resetFilters() {
        document.getElementById('repFrom').value = "";
        document.getElementById('repTo').value = "";
        document.getElementById('repMonthFilter').value = "";
        document.getElementById('reportPreview').innerHTML = "";
    }

    // --- UPDATED REPORT GENERATION LOGIC (ROBUST VERSION) ---
    function genReport(mode) {
        let f = document.getElementById('repFrom').value;
        let t = document.getElementById('repTo').value;
        let m = document.getElementById('repMonthFilter').value;
        
        // Error Check: From Date cannot be after To Date
        if(f && t && f > t) {
            alert("Error: 'From Date' cannot be after 'To Date'. Please fix.");
            return;
        }

        // Display Header Text Logic
        let filterText = "All Time (No Filter)";
        if(m) filterText = `Selected Month: ${m}`;
        else if(f || t) filterText = `Date Range: ${f || 'Start'} to ${t || 'End'}`;
        
        let h = `<div style="text-align:center;"><img src="${academyLogo}" style="width:60px; vertical-align:middle;"><h2 style="display:inline-block; margin:0 20px;">IKHAR COMPUTER ACADEMY</h2><h3>${mode.replace('_', ' ')} REPORT</h3><p>Filter Criteria: ${filterText}</p></div><hr>`;
        
        // --- FIXED DATE CHECK LOGIC (Strict Priority) ---
        let dateCheck = (x) => {
            if(!x.date && !x.period) return false; // Safety check

            // 1. If Month is selected, STRICTLY use Month (ignores date range)
            if(m !== "") {
                if(x.period) return x.period === m;
                return x.date.startsWith(m);
            }

            // 2. If Date Range is selected (even partial), use Date Range
            if(f !== "" || t !== "") {
                let checkDate = x.date || (x.period ? `${x.period}-01` : "");
                if(!checkDate) return false;
                if(f !== "" && checkDate < f) return false;
                if(t !== "" && checkDate > t) return false;
                return true;
            }

            // 3. No filters selected? Show Everything.
            return true;
        };

        if(mode === 'COURSE') { 
            let filt = fees.filter(x => x.type === 'COURSE' && dateCheck(x));
            h += `<table border="1"><tr><th>Roll</th><th>Name</th><th>Course</th><th>For Month</th><th>Course Fee</th><th>Zakat</th><th>Total</th></tr>`;
            filt.forEach(x => h += `<tr><td>${x.sid}</td><td>${x.name}</td><td>${x.course}</td><td>${x.period}</td><td>${x.v1}</td><td>${x.v2}</td><td>‚Çπ${x.total}</td></tr>`);
            h += `<tr style="font-weight:bold; background:#f8fafc;"><td colspan="4">TOTAL</td><td>‚Çπ${filt.reduce((a,b)=>a+b.v1,0)}</td><td>‚Çπ${filt.reduce((a,b)=>a+b.v2,0)}</td><td>‚Çπ${filt.reduce((a,b)=>a+b.total,0)}</td></tr></table>`;
        }
        else if(mode === 'EXPENSE') {
            let filt = expenses.filter(x => dateCheck(x));
            h += `<table border="1"><tr><th>Date</th><th>Description</th><th>Amount</th></tr>`;
            filt.forEach(x => h += `<tr><td>${x.date}</td><td>${x.name}</td><td>‚Çπ${x.amt}</td></tr>`);
            h += `<tr style="font-weight:bold; color:red"><td colspan="2">TOTAL EXPENSES</td><td>‚Çπ${filt.reduce((a,b)=>a+b.amt,0)}</td></tr></table>`;
        }
        else if(mode === 'BALANCE') {
            let feesFilt = fees.filter(x => dateCheck(x));
            let expFilt = expenses.filter(x => dateCheck(x));
            let coll = feesFilt.filter(x => x.type === 'COURSE').reduce((a,b)=>a+(parseFloat(b.v1)||0),0); 
            let exp = expFilt.reduce((a,b)=>a+b.amt,0);
            let net = coll - exp;
            h += `<div style="padding:20px; border:1px solid #000; margin-top:10px;"><p style="font-size:18px;"><b>(+) Course Collection (Fees Only):</b> ‚Çπ${coll}</p><hr><p style="font-size:18px; color:red;"><b>(-) Total Expenses:</b> ‚Çπ${exp}</p><hr style="border:2px solid #000"><h2 style="text-align:right; color:${net>=0?'green':'red'}">NET PROFIT/LOSS: ‚Çπ${net}</h2><p style="font-size:12px; color:gray;">*Note: Zakat and Exam/Cert funds are excluded from this sheet.</p></div>`;
        }
        else if(mode === 'ZAKAT') {
            let filt = fees.filter(x => x.type === 'COURSE' && x.v2 > 0 && dateCheck(x));
            h += `<table border="1"><tr><th>Roll</th><th>Name</th><th>Zakat Amount</th></tr>`;
            filt.forEach(x => h += `<tr><td>${x.sid}</td><td>${x.name}</td><td>‚Çπ${x.v2}</td></tr>`);
            h += `<tr style="font-weight:bold"><td colspan="2">TOTAL</td><td>‚Çπ${filt.reduce((a,b)=>a+b.v2,0)}</td></tr></table>`;
        }
        else if(mode === 'EXAM') {
            let filt = fees.filter(x => x.type === 'EXAM' && dateCheck(x));
            h += `<table border="1"><tr><th>Roll No</th><th>Student Name</th><th>Course</th><th>Duration</th><th>Start Date</th><th>End Date</th><th>Exam Fees</th></tr>`;
            filt.forEach(x => h += `<tr><td>${x.sid}</td><td>${x.name}</td><td>${x.course}</td><td>${x.dur||'-'}</td><td>${x.admDate||'-'}</td><td>${x.toDate||'-'}</td><td>‚Çπ${x.v1}</td></tr>`);
            h += `<tr style="font-weight:bold"><td colspan="6" style="text-align:right">GRAND TOTAL</td><td>‚Çπ${filt.reduce((a,b)=>a+(parseFloat(b.v1)||0),0)}</td></tr></table>`;
        }
        else if(mode === 'DUE') {
            // Due report is a snapshot of current status, so filters don't apply, but we show the list anyway
            let filt = students.filter(s => s.status === 'Active' && (s.total-s.paid) > 0);
            h += `<p><i>Note: Due Report shows current live status. Date filters do not apply here.</i></p>`;
            h += `<table border="1"><tr><th>Roll</th><th>Name</th><th>Mobile</th><th>Course</th><th>Total</th><th>Paid</th><th>Due</th></tr>`;
            filt.forEach(x => h += `<tr><td>${x.id}</td><td>${x.name}</td><td>${x.mob}</td><td>${x.course}</td><td>${x.total}</td><td>${x.paid}</td><td style="color:red">‚Çπ${x.total-x.paid}</td></tr>`);
            h += `<tr style="font-weight:bold"><td colspan="6">TOTAL DUE</td><td>‚Çπ${filt.reduce((a,b)=>a+(b.total-b.paid),0)}</td></tr></table>`;
        }
        // --- UPDATED ATTENDANCE MATRIX LOGIC (Compatible with new logic) ---
        else if(mode === 'ATT_S_REP' || mode === 'ATT_T_REP') {
            let isStudent = (mode === 'ATT_S_REP');
            let list = isStudent ? students.filter(s=>s.status==='Active') : teachers;
            let logData = isStudent ? attDataS : attDataT;

            let datesArray = [];
            
            // PRIORITY 1: RANGE
            if(f && t) {
                let curr = new Date(f);
                let end = new Date(t);
                while(curr <= end) {
                    datesArray.push(curr.toISOString().split('T')[0]);
                    curr.setDate(curr.getDate() + 1);
                }
            } 
            // PRIORITY 2: MONTH
            else if(m) {
                let [yr, mn] = m.split('-');
                let daysInMonth = new Date(yr, mn, 0).getDate();
                for(let d=1; d<=daysInMonth; d++) {
                    datesArray.push(`${yr}-${mn}-${String(d).padStart(2,'0')}`);
                }
            } else {
                return alert("For Attendance Matrix, you MUST select a full 'From' and 'To' date range OR a Month.");
            }

            h += `<div style="overflow-x:auto;"><table border="1" style="font-size:12px; text-align:center; border-collapse:collapse; width:100%;"><thead><tr style="height:30px;">
                  <th style="min-width:100px; text-align:left; padding-left:5px;">Name</th>`;
            
            datesArray.forEach(d => {
                let dObj = new Date(d);
                let isSun = dObj.getDay() === 0; 
                let day = dObj.getDate();
                let style = isSun ? "background:#ef4444; color:white;" : "background:#f1f5f9;";
                h += `<th style="width:25px; ${style}">${day}</th>`;
            });
            h += `<th style="width:40px;">Pres</th><th style="width:40px;">Abs</th></tr></thead><tbody>`;

            list.forEach(person => {
                let pCount = 0;
                let aCount = 0;
                let rowHtml = `<tr><td style="text-align:left; font-weight:bold; padding-left:5px;">${person.name}</td>`;
                
                datesArray.forEach(d => {
                    let dObj = new Date(d);
                    let isSun = dObj.getDay() === 0;

                    let dayLog = logData.find(x => x.date === d);
                    let status = (dayLog && dayLog.data && dayLog.data[person.id]) ? dayLog.data[person.id] : '-';
                    
                    let color = '#ccc';
                    let bg = '';
                    if(isSun) { bg = 'background:#fee2e2;'; color = '#ef4444'; }

                    if(status === 'P') { color = 'green'; pCount++; }
                    if(status === 'A') { color = 'red'; aCount++; }
                    
                    rowHtml += `<td style="color:${color}; font-weight:bold; ${bg}">${status}</td>`;
                });

                rowHtml += `<td style="background:#d1fae5">${pCount}</td><td style="background:#fee2e2">${aCount}</td></tr>`;
                h += rowHtml;
            });

            h += `</tbody></table></div><p style="font-size:12px; color:gray;">P=Present, A=Absent, -=Not Marked. Sundays are highlighted in Red.</p>`;
        }
        
        document.getElementById('reportPreview').innerHTML = h;
    }

    function genStudentRecord() {
        let roll = document.getElementById('searchRoll').value;
        let s = students.find(x => x.id === roll);
        if(!s) return alert("Student Not Found");
        let hist = fees.filter(x => x.sid === roll);
        let h = `<div style="display:flex; align-items:center; gap:20px; margin-bottom:10px;"><img src="${academyLogo}" style="width:60px;"><h2>STUDENT LEDGER</h2></div><hr><div style="display:flex; gap:20px; align-items:center;"><img src="${s.photo}" style="width:100px; border:1px solid #000;"><div><h3>${s.name} [${s.status}]</h3><p><b>Mobile:</b> ${s.mob} | <b>Course:</b> ${s.course}</p><p><b>Total Course Fees:</b> ${s.total} | <b>Total Paid:</b> ${s.paid} | <b>Due:</b> <span style="color:red">${s.status==='Left'?0:s.total-s.paid}</span></p></div></div><table border="1" style="width:100%; border-collapse:collapse; margin-top:15px;"><thead><tr style="background:#f1f5f9;"><th>Date</th><th>Type/Period</th><th>Receipt No</th><th>Paid (Course/Exam)</th><th>Zakat Fund</th><th>Total</th></tr></thead><tbody>`;
        let sumPaid = 0; let sumZakat = 0; let sumTotal = 0;
        hist.forEach(x => {
            let rowPaid = 0; let rowZakat = 0;
            if(x.type === 'EXAM') { rowPaid = (parseFloat(x.v1) || 0) + (parseFloat(x.v2) || 0); rowZakat = 0; } else { rowPaid = parseFloat(x.v1) || 0; rowZakat = parseFloat(x.v2) || 0; }
            let rowTotal = rowPaid + rowZakat; sumPaid += rowPaid; sumZakat += rowZakat; sumTotal += rowTotal;
            h += `<tr><td>${x.date}</td><td>${x.type} ${x.period || ''}</td><td>${x.rNo}</td><td>‚Çπ${rowPaid}</td><td>‚Çπ${rowZakat}</td><td style="font-weight:bold;">‚Çπ${rowTotal}</td></tr>`;
        });
        h += `</tbody><tfoot><tr style="font-weight:bold; background:#eee;"><td colspan="3" style="text-align:right; padding:10px;">GRAND TOTALS:</td><td style="padding:10px; color:var(--accent);">‚Çπ${sumPaid}</td><td style="padding:10px; color:var(--gold);">‚Çπ${sumZakat}</td><td style="padding:10px; color:black;">‚Çπ${sumTotal}</td></tr></tfoot></table>`;
        document.getElementById('reportPreview').innerHTML = h;
    }

    function printCert() {
        let i = document.getElementById('certDrop').value;
        if(i === "") return alert("Select Student First");
        let s = students[i], g = document.getElementById('certGrade').value;
        let h = `<div class="cert-box"><img src="${academyLogo}" class="cert-watermark"><div class="cert-inner"><div class="cert-header"><img src="${academyLogo}" class="cert-logo"><h1 class="cert-title">IKHAR COMPUTER ACADEMY</h1></div><p style="letter-spacing:3px; font-weight:bold; color:var(--gold); margin-top:20px;">CERTIFICATE OF ACHIEVEMENT</p><p style="font-size:20px; margin:20px 0;">This is to certify that</p><div class="cert-student-name">${s.name.toUpperCase()}</div><p style="font-size:18px;">has successfully completed the prescribed course of study in</p><h2 style="font-style:italic; font-size:28px; color:var(--accent);">${s.course}</h2><p style="font-size:18px;">conducted from <b>${s.date}</b> to <b>${s.toDate || ''}</b> and attained Grade <b>"${g}"</b>.</p><div style="display:flex; justify-content:space-between; margin-top:60px; padding:0 40px;"><div style="text-align:center;"><hr style="width:180px;"><b>Centre Director</b></div><div style="text-align:center;"><hr style="width:180px;"><b>Exam Controller</b></div></div></div></div>`;
        document.getElementById('printArea').innerHTML = h; window.print();
    }
    
    function printIdCard() {
        let i = document.getElementById('certDrop').value;
        if(i === "") return alert("Select Student First");
        let s = students[i];
        let h = `<div style="display:flex; justify-content:center; align-items:center; height:100vh;"><div class="id-card-box"><div class="id-header"><img src="${academyLogo}" style="width:35px; height:35px; background:white; border-radius:4px;"><div><h3 style="margin:0; font-size:14px;">IKHAR COMPUTER ACADEMY</h3><small style="font-size:10px;">Student Identity Card</small></div></div><div class="id-body"><img src="${s.photo}" style="width:80px; height:90px; border:1px solid #ddd; object-fit:cover;"><div style="font-size:12px; line-height:1.4;"><p style="margin:0"><b>Name:</b> ${s.name}</p><p style="margin:0"><b>Roll No:</b> ${s.id}</p><p style="margin:0"><b>Course:</b> ${s.course}</p><p style="margin:0"><b>Mobile:</b> ${s.mob}</p></div></div><div class="id-footer">Authorized Signature</div></div></div>`;
        document.getElementById('printArea').innerHTML = h; window.print();
    }

    function printAdmForm() {
        let i = document.getElementById('certDrop').value;
        if(i === "") return alert("Select Student First");
        let s = students[i];
        let h = `<div class="adm-form-box"><div style="display:flex; align-items:center; gap:20px; border-bottom:2px solid black; padding-bottom:15px;"><img src="${academyLogo}" style="width:80px;"><div><h1 style="margin:0;">IKHAR COMPUTER ACADEMY</h1><p style="margin:0;">Admission & Enrolment Form</p></div><div style="margin-left:auto; border:1px solid black; width:100px; height:120px; display:flex; align-items:center; justify-content:center;"><img src="${s.photo}" style="width:100%; height:100%; object-fit:cover;"></div></div><table style="width:100%; margin-top:30px; border-collapse:collapse; font-size:18px;"><tr><td style="padding:10px; border:1px solid #000; width:30%;"><b>Registration No / Roll:</b></td><td style="padding:10px; border:1px solid #000;">${s.id}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Student Name:</b></td><td style="padding:10px; border:1px solid #000;">${s.name}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Course Name:</b></td><td style="padding:10px; border:1px solid #000;">${s.course}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Duration:</b></td><td style="padding:10px; border:1px solid #000;">${s.dur}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Total Fees:</b></td><td style="padding:10px; border:1px solid #000;">‚Çπ${s.total}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Contact Mobile:</b></td><td style="padding:10px; border:1px solid #000;">${s.mob}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Date of Joining:</b></td><td style="padding:10px; border:1px solid #000;">${s.date}</td></tr><tr><td style="padding:10px; border:1px solid #000;"><b>Completion Date:</b></td><td style="padding:10px; border:1px solid #000;">${s.toDate || 'Ongoing'}</td></tr></table><div style="margin-top:40px;"><h3><u>Declaration</u></h3><p>I hereby declare that the information provided above is true to the best of my knowledge. I agree to abide by the rules and regulations of Ikhar Computer Academy.</p></div><div style="display:flex; justify-content:space-between; margin-top:80px;"><div style="text-align:center;">_______________________<br>Student Signature</div><div style="text-align:center;">_______________________<br>Office Seal & Sign</div></div></div>`;
        document.getElementById('printArea').innerHTML = h; window.print();
    }

    function updateCharts() {
        if(revChart) revChart.destroy(); if(dueChart) dueChart.destroy();
        let coll = fees.filter(x=>x.type==='COURSE').reduce((a,b)=>a+(parseFloat(b.v1)||0),0);
        let exp = expenses.reduce((a,b)=>a+b.amt,0);
        revChart = new Chart(document.getElementById('revChart'), { type: 'bar', data: { labels: ['Course Coll','Expenses'], datasets: [{label:'Rupees ‚Çπ', data:[coll,exp], backgroundColor:['#10b981','#ef4444']}]}});
        dueChart = new Chart(document.getElementById('dueChart'), { type: 'doughnut', data: { labels: ['Profit','Expense'], datasets: [{data:[Math.max(0, coll-exp), exp], backgroundColor:['#10b981','#ef4444']}]}});
    }

    function tab(id, b) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active')); document.getElementById(id).classList.add('active'); b.classList.add('active'); }
    function readImg(el) { let r = new FileReader(); r.onload=(e)=>tempImg=e.target.result; r.readAsDataURL(el.files[0]); }
    function saveLogo(el) { let r = new FileReader(); r.onload=(e)=>{ academyLogo=e.target.result; sync(); location.reload(); }; r.readAsDataURL(el.files[0]); }
    function resetForm() { document.getElementById('editIdx').value="-1"; ['sGr', 'sName', 'sCourse', 'sDur', 'sTotal', 'sDate', 'sToDate', 'sMob'].forEach(i=>document.getElementById(i).value=""); tempImg=""; }
    function editS(i) { let s = students[i]; document.getElementById('editIdx').value=i; document.getElementById('sGr').value=s.id; document.getElementById('sName').value=s.name; document.getElementById('sCourse').value=s.course; document.getElementById('sDur').value=s.dur; document.getElementById('sTotal').value=s.total; document.getElementById('sMob').value=s.mob; document.getElementById('sDate').value=s.date; document.getElementById('sToDate').value=s.toDate; tab('adm', document.querySelector('.nav-btn:nth-child(2)')); }
    function toggleS(i) { students[i].status = students[i].status === "Active" ? "Left" : "Active"; sync(); }
    
    function renderDatabase() {
        let q = document.getElementById('dbSearch').value.toLowerCase();
        let filt = students.filter(s => s.name.toLowerCase().includes(q) || s.id.includes(q));
        document.getElementById('grBody').innerHTML = `<tr><th>Roll</th><th>Name</th><th>Course</th><th>Status</th><th>Due</th><th>Edit</th></tr>` + 
        filt.map((s,i) => `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.course}</td><td><button style="background:${s.status==='Active'?'#10b981':'#ef4444'}; color:white;" onclick="toggleS(${students.indexOf(s)})">${s.status}</button></td><td>‚Çπ${s.status==='Left'?0:s.total-s.paid}</td><td><button onclick="editS(${students.indexOf(s)})">Edit</button></td></tr>`).join('');
    }
    
    function updateDueLabel() { 
        let i = document.getElementById('feeDrop1').value; 
        if(i!=="") { let s = students[i]; document.getElementById('dueLabel').innerText = "‚Çπ" + (s.status === 'Left' ? 0 : (s.total - s.paid)); } 
        else document.getElementById('dueLabel').innerText = "‚Çπ0"; 
    }
    
    function printThisReport() { document.getElementById('printArea').innerHTML = document.getElementById('reportPreview').innerHTML; window.print(); }
    function masterReset() { if(prompt("Auth Code:")==="ica007") { db.ref('ica_final_v3').remove(); location.reload(); } }

    function render() {
        let coll = fees.filter(x=>x.type==='COURSE').reduce((a,b)=>a+(parseFloat(b.v1)||0),0); 
        let zakat = fees.filter(x=>x.type==='COURSE').reduce((a,b)=>a+(parseFloat(b.v2)||0),0);
        let exp = expenses.reduce((a,b)=>a+b.amt,0);
        document.getElementById('dColl').innerText = "‚Çπ" + coll;
        document.getElementById('dZakat').innerText = "‚Çπ" + zakat;
        document.getElementById('dExp').innerText = "‚Çπ" + exp;
        document.getElementById('dNet').innerText = "‚Çπ" + (coll - exp);
        document.getElementById('dNet').style.color = (coll - exp) >= 0 ? "var(--success)" : "var(--danger)";
        document.getElementById('d1').innerText = students.filter(s => s.status === "Active").length;
        document.getElementById('dDue').innerText = "‚Çπ" + students.filter(s=>s.status==='Active').reduce((a,b)=>a+(b.total-b.paid),0);
        let opts = students.map((s, i) => ({...s, originalIndex: i})).filter(s => s.status === 'Active').map(s => `<option value="${s.originalIndex}">${s.name} (${s.id})</option>`).join('');
        document.getElementById('feeDrop1').innerHTML = document.getElementById('feeDrop2').innerHTML = document.getElementById('certDrop').innerHTML = '<option value="">--Select--</option>'+opts;
        renderDatabase();
    }
</script>
</body>
</html>
